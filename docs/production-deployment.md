app/src/components/assessment/IdentityFoundationsAssessment.tsx
85	0	0	85
0.00%
prompt-service/src/services/prompt.service.ts
71	1	0	70
1.41%
prompt-service/src/services/ab-test.service.ts
74	13	0	61
17.57%
prompt-service/src/services/user.service.ts
270	215	0	55
79.63%
backend/src/services/prompt-client.service.ts
119	82	0	37
68.91%
app/src/components/insights/IdentityInsightsAI.tsx
118	83	0	35
70.34%
app/src/hooks/useResourceLoader.ts
145	111	0	34
76.55%
app/src/components/shared/ExportDropdown.tsx
31	1	0	30
3.23%
app/src/components/shared/UserAvatarDropdown.tsx
27	1	0	26
3.70%
app/src/services/api/ApiClient.ts
128	102	0	26
79.69%
app/src/components/profile/ProfilePage.tsx
209	183	1	25
87.56%
prompt-service/src/controllers/ab-test.controller.ts
112	95	0	17
84.82%
prompt-service/src/controllers/prompt.controller.ts
87	75	0	12
86.21%
app/src/components/insights/InsightsPageHeader.tsx
11	1	0	10
9.09%
app/src/services/api/AuthService.ts
78	68	0	10
87.18%
prompt-service/src/middleware/jwt-auth.middleware.ts
43	34	0	9
79.07%
app/src/components/shared/ChunkErrorBoundary.tsx
40	33	0	7
82.50%
app/src/components/assessment/AssessmentPageHeader.tsx
6	1	0	5
16.67%
app/src/components/auth/forms/RegisterForm.tsx
73	68	0	5
93.15%
app/src/stores/useUIStore.ts
19	14	0	5
73.68%
shared/src/validation.ts
18	13	0	5
72.22%
backend/src/middleware/tracing.middleware.ts
5	0	0	5
0.00%
backend/src/utils/error-sanitizer.ts
15	10	0	5
66.67%
prompt-service/src/utils/jwt.ts
29	24	0	5
82.76%
app/src/components/auth/forms/PasswordResetConfirmForm.tsx
46	42	0	4
91.30%
app/src/components/insights/SavePromptModal.tsx
6	2	0	4
33.33%
shared/src/responseFormatter.ts
13	10	0	3
76.92%
backend/src/services/prompt-cache.service.ts
87	84	0	3
96.55%
app/src/components/auth/AuthLayout.tsx
20	16	2	2
80.00%
app/src/components/auth/forms/FormInput.tsx
24	21	1	2
87.50%
app/src/hooks/useRouting.ts
88	86	0	2
97.73%
backend/src/services/circuit-breaker.service.ts
31	29	0	2
93.55%
backend/src/utils/background-refresh-manager.ts
75	73	0	2
97.33%
prompt-service/src/middleware/admin-auth.middleware.ts
27	25	0	2
92.59%
app/src/components/auth/EmailVerificationPage.tsx
61	60	0	1
98.36%
app/src/components/auth/forms/LoginForm.tsx
41	40	0	1
97.56%
app/src/utils/fileUtils.ts
44	43	0	1
97.73%
prompt-service/src/controllers/resolve.controller.ts
22	21	0	1
95.45%
prompt-service/src/prisma/client.ts
10	9	0	1
90.00%
prompt-service/src/services/email.service.ts
68	67	0	1
98.53%
prompt-service/src/services/prompt-resolver.service.ts
42	41	0	1
97.62%
prompt-service/src/utils/csrf.ts
10	9	0	1
90.00%
prompt-service/src/utils/logger.ts
3	2	0	1
66.67%
prompt-service/src/utils/sanitize.ts
12	11	0	1
91.67%
app/src/components/assessment/hooks/useAssessmentNavigation.ts
31	31	0	0
100.00%
app/src/components/assessment/navigation/AssessmentProgress.tsx
5	5	0	0
100.00%
app/src/components/assessment/navigation/NavigationControls.tsx
20	20	0	0
100.00%
app/src/components/assessment/steps/IntroStep.tsx
8	8	0	0
100.00%
app/src/components/assessment/steps/MultiSelectStep.tsx
24	24	0	0
100.00%
app/src/components/assessment/steps/ScaleStep.tsx
14	14	0	0
100.00%
app/src/components/assessment/steps/SingleSelectStep.tsx
20	20	0	0
100.00%
app/src/components/assessment/steps/SynthesisStep.tsx
48	48	0	0
100.00%
app/src/components/assessment/steps/TextareaStep.tsx
7	7	0	0
100.00%
app/src/components/auth/AuthGuard.tsx
16	16	0	0
100.00%
app/src/components/auth/AuthPage.tsx
39	39	0	0
100.00%
app/src/components/auth/PasswordResetPage.tsx
11	11	0	0
100.00%
app/src/components/auth/forms/FormButton.tsx
15	15	0	0
100.00%
app/src/components/insights/InsightCard.tsx
31	31	0	0
100.00%
app/src/components/shared/DateBadge.tsx
7	7	0	0
100.00%
app/src/components/shared/InkBrushDecoration.tsx
5	5	0	0
100.00%
app/src/components/shared/LanguageToggle.tsx
13	13	0	0
100.00%
app/src/components/shared/LoadingFallback.tsx
5	5	0	0
100.00%
app/src/config/auth.config.ts
1	1	0	0
100.00%
app/src/contexts/ThemeContext.ts
1	1	0	0
100.00%
app/src/services/api/ClaudeService.ts
11	11	0	0
100.00%
app/src/stores/useAnalysisStore.ts
45	45	0	0
100.00%
app/src/stores/useAssessmentStore.ts
30	30	0	0
100.00%
app/src/stores/useAuthStore.ts
33	33	0	0
100.00%
shared/src/labels.ts
4	4	0	0
100.00%
worker/src/jobs/token-cleanup.job.ts
14	14	0	0
100.00%
worker/src/scheduler/index.ts
43	43	0	0
100.00%
backend/src/controllers/claude.controller.ts
13	13	0	0
100.00%
backend/src/controllers/health.controller.ts
12	12	0	0
100.00%
backend/src/health/health-service.ts
53	53	0	0
100.00%
backend/src/health/checks/anthropic.check.ts
12	12	0	0
100.00%
backend/src/health/checks/prompt-cache.check.ts
6	6	0	0
100.00%
backend/src/health/checks/prompt-service.check.ts
15	15	0	0
100.00%
backend/src/middleware/cors.middleware.ts
1	1	0	0
100.00%
backend/src/middleware/error.middleware.ts
23	23	0	0
100.00%
backend/src/services/claude.service.ts
46	46	0	0
100.00%
backend/src/services/claude/response-parser.ts
5	5	0	0
100.00%
backend/src/utils/fetch-with-timeout.ts
9	9	0	0
100.00%
backend/src/utils/json-validator.ts
11	11	0	0
100.00%
backend/src/utils/logger.ts
5	5	0	0
100.00%
backend/src/validators/claude.validator.ts
8	8	0	0
100.00%
app/src/utils/logger.ts
21	21	0	0
100.00%
worker/src/config/index.ts
19	19	0	0
100.00%
prompt-service/src/constants/auth.ts
1	1	0	0
100.00%
prompt-service/src/middleware/csrf.middleware.ts
17	17	0	0
100.00%
prompt-service/src/middleware/rate-limit.middleware.ts
9	9	0	0
100.00%
prompt-service/src/middleware/tracing.middleware.ts
5	5	0	0
100.00%
prompt-service/src/utils/auth.ts
4	4	0	0
100.00%
prompt-service/src/utils/crypto.ts
11	11	0	0
100.00%
prompt-service/src/utils/password.ts
12	12	0	0
100.00%
prompt-service/src/utils/token.ts
13	13	0	0
100.00%
prompt-service/src/validators/ab-test.validator.ts
11	11	0	0
100.00%
prompt-service/src/validators/auth.validator.ts
13	13	0	0
100.00%
prompt-service/src/validators/prompt.validator.ts
8	8	0	0
100.00%
prompt-service/src/validators/resolve.validator.ts
# Production Deployment Guide

This guide covers security considerations and configuration requirements for deploying Votive in production environments.

## Environment Variables

### Backend Service

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `ANTHROPIC_API_KEY` | Yes | - | Anthropic API key for Claude |
| `NODE_ENV` | Yes | development | Set to `production` |
| `BACKEND_PORT` | No | 3001 | Server port |
| `BACKEND_HTTPS_ENABLED` | No | true | Enable HTTPS |
| `HTTPS_KEY_PATH` | No | ../certs/localhost+2-key.pem | Path to SSL key file |
| `HTTPS_CERT_PATH` | No | ../certs/localhost+2.pem | Path to SSL certificate file |
| `CORS_ORIGIN` | Yes | - | Allowed frontend origin |
| `RATE_LIMIT_WINDOW_MS` | No | 60000 | Rate limit window (ms) |
| `RATE_LIMIT_MAX_REQUESTS` | No | 10 | Max requests per window |
| `CLAUDE_RATE_LIMIT_WINDOW_MS` | No | 60000 | Claude API rate limit window (ms) |
| `CLAUDE_RATE_LIMIT_MAX_REQUESTS` | No | 5 | Claude API max requests per window |
| `LOG_LEVEL` | No | info | Pino log level (fatal, error, warn, info, debug, trace) |
| `THINKING_ENABLED` | No | true | Enable Claude extended thinking |
| `PROMPT_SERVICE_URL` | Yes | - | Prompt service internal URL |
| `CIRCUIT_BREAKER_TIMEOUT` | No | 10000 | Circuit breaker timeout (ms) |
| `CIRCUIT_BREAKER_RESET_TIMEOUT` | No | 30000 | Circuit breaker reset (ms) |
| `CIRCUIT_BREAKER_ERROR_THRESHOLD` | No | 50 | Error threshold percentage to open circuit |

### Prompt Service

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NODE_ENV` | Yes | development | Set to `production` |
| `PROMPT_SERVICE_PORT` | No | 3002 | Server port |
| `DATABASE_URL` | Yes | - | SQLite database path |
| `DATABASE_KEY` | Yes | - | 32+ char encryption key for SQLCipher |
| `ADMIN_API_KEY` | Yes | - | 32+ char admin authentication key |
| `SESSION_SECRET` | Yes | - | 32+ char cookie signing secret |
| `CORS_ORIGINS` | Yes | - | Comma-separated allowed origins |
| `LOG_LEVEL` | No | info | Pino log level (fatal, error, warn, info, debug, trace) |
| `RATE_LIMIT_WINDOW_MS` | No | 60000 | Rate limit window (ms) |
| `RATE_LIMIT_LOGIN` | No | 5 | Login attempts per window |
| `RATE_LIMIT_REGISTER` | No | 5 | Registration attempts per window |
| `RATE_LIMIT_PASSWORD_RESET` | No | 3 | Password reset requests per window |
| `RATE_LIMIT_FORGOT_PASSWORD` | No | 3 | Password reset confirms per window |
| `RATE_LIMIT_TOKEN_REFRESH` | No | 20 | Token refresh requests per window |
| `RATE_LIMIT_USER_DATA` | No | 30 | Assessment/analysis requests per window |
| `RATE_LIMIT_PROFILE` | No | 15 | Profile operations per window |

**Important:** `SESSION_SECRET` must differ from `ADMIN_API_KEY` in production for security. In development, at least one of `SESSION_SECRET` or `ADMIN_API_KEY` must be setâ€”the service will fail to start with a clear error message if neither is configured. When only `ADMIN_API_KEY` is set, it's used as the session secret and a warning is logged.

### Worker Service

The worker service handles background jobs like token cleanup. It shares the database with prompt-service.

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NODE_ENV` | Yes | development | Set to `production` |
| `DATABASE_URL` | Yes | - | SQLite database path (same as prompt-service) |
| `DATABASE_KEY` | Yes | - | 32+ char encryption key (same as prompt-service) |
| `LOG_LEVEL` | No | info | Pino log level |
| `JOB_TOKEN_CLEANUP_ENABLED` | No | true | Enable token cleanup job |
| `JOB_TOKEN_CLEANUP_SCHEDULE` | No | 0 * * * * | Cron schedule (hourly default) |

**Cron Schedule Examples:**
- `0 * * * *` - Every hour at minute 0 (default)
- `*/30 * * * *` - Every 30 minutes
- `0 0 * * *` - Daily at midnight
- `0 0 * * 0` - Weekly on Sunday at midnight

## Docker Compose Configuration

Votive uses [dotenvx](https://dotenvx.com) for encrypted environment variable management. The `.env` file is encrypted and committed to the repository - you only need the decryption key to run.

### Running with Docker Compose

```bash
# Pass the decryption key - all other secrets are in the encrypted .env
DOTENV_PRIVATE_KEY=<your-private-key> docker compose up --build
```

### How It Works

| File | Description | Commit to Git? |
|------|-------------|----------------|
| `.env` | Encrypted secrets | Yes (safe) |
| `.env.keys` | Private decryption key | **Never** |
| `DOTENV_PRIVATE_KEY` | Runtime decryption | Pass via env/secrets manager |

At container startup, dotenvx decrypts the `.env` file using the private key and injects all variables into the process environment.

## Rate Limiting

### Single Instance

The default in-memory rate limiting works correctly for single-instance deployments.

### Multi-Instance Deployments

For deployments behind a load balancer with multiple instances, see [GitHub Issue #16](https://github.com/Oxilith/Votive/issues/16) for Redis-backed rate limiting setup.

## Security Considerations

### Input Validation

- Prompt content is limited to 50,000 characters (50KB)
- Content is validated for XSS patterns (script tags, event handlers, etc.)
- Keys must be UPPER_SNAKE_CASE format

### Authentication

- Admin UI uses HttpOnly cookies with:
  - `secure: true` (HTTPS only in production)
  - `sameSite: 'strict'` (CSRF protection)
  - `signed: true` (tamper detection)
- API key fallback uses timing-safe comparison

### CSRF Protection

User authentication endpoints use double-submit cookie pattern:
- CSRF token set on login/register (cookie + response body)
- Token validated for state-changing requests (POST/PUT/DELETE)
- Cookie: `csrf-token` with `sameSite: 'strict'`, `secure: true` in production
- Header: `x-csrf-token` (sent by frontend)
- Timing-safe comparison prevents timing attacks

Protected endpoints:
- `/logout`, `/logout-all`
- `/profile`, `/password`, `/account`
- `/resend-verification`
- `/assessment`, `/analysis` (save operations)

### Password Requirements

User passwords must meet:
- Minimum 8 characters
- At least one uppercase letter (A-Z)
- At least one lowercase letter (a-z)
- At least one number (0-9)

### Distributed Tracing

W3C Trace Context headers (OpenTelemetry compatible):
- `traceparent` header propagated through all services
- Format: `00-{traceId}-{spanId}-01`
- TraceId/SpanId included in all Pino log entries
- Worker jobs include trace context for correlation

### Database Encryption

- SQLite database is encrypted using SQLCipher via libsql
- Encryption key must be at least 32 characters
- Key is never logged or exposed in error messages

## Circuit Breaker Configuration

The backend uses circuit breakers for prompt-service communication:

| Setting | Default | Description |
|---------|---------|-------------|
| Timeout | 10s | Per-request timeout |
| Error Threshold | 50% | Errors before circuit opens |
| Reset Timeout | 30s | Time before retry attempt |
| Volume Threshold | 5 | Minimum requests before calculating threshold |

When the circuit opens:
- Requests fail fast with 503
- Stale cached data is returned if available
- Background refresh is scheduled

## Health Checks

| Endpoint | Service | Description |
|----------|---------|-------------|
| `/health` | Backend | Overall health + dependencies |
| `/health` | Prompt Service | Service health |
| `/health/live` | Backend | Liveness probe |
| `/health/ready` | Backend | Readiness probe |

## Logging

Both services use Pino for structured JSON logging:

```bash
LOG_LEVEL=info  # Options: fatal, error, warn, info, debug, trace
```

## Monitoring

Consider adding:
- Prometheus metrics endpoint (see [Issue #12](https://github.com/Oxilith/Votive/issues/12))
- Grafana dashboards (see [Issue #14](https://github.com/Oxilith/Votive/issues/14))
- Distributed tracing (see [Issue #11](https://github.com/Oxilith/Votive/issues/11))
